# Balance service

Проект сделан в
рамках [тестового задания на позицию стажёра-бэкендера](https://github.com/avito-tech/internship_backend_2022).

## Запуск

Скопировать файл `.env.example` в `.env`, при необходимости изменить настройки по умолчанию.

Далее запустить контейнеры:

```shell
docker-compose up
```
    
Развернуть схему таблиц для базы данных из файла resources/schema.sql

## Документация API

### Начисление средств на баланс

#### Запрос

```http
POST /v1/transactions/replenish
```

| Параметр  | Тип     | Описание                                     |
|:----------|:--------|:---------------------------------------------|
| `user_id` | `int64` | **Обязательный**. Идентификатор пользователя |
| `amount`  | `int64` | **Обязательный**. Сумма пополнения           |

```json
{
  "user_id": 1,
  "amount": 1000
}
```

#### Ответ

##### Успешное пополнение

```json
{
  "balance": 1000,
  "user_id": 1
}
```

Код ответа `201`. Поле `balance` содержит баланс пользователя после пополнения. Поле `user_id` содержит переданный
идентификатор
пользователя.

### Резервирование средств

#### Запрос

```http
POST /transactions/reserve
```

| Параметр     | Тип     | Описание                                     |
|:-------------|:--------|:---------------------------------------------|
| `user_id`    | `int64` | **Обязательный**. Идентификатор пользователя |
| `amount`     | `int64` | **Обязательный**. Сумма резервирования       |
| `service_id` | `int64` | **Обязательный**. Идентификатор услуги       |
| `order_id`   | `int64` | **Обязательный**. Идентификатор заказа       |

```json
{
  "user_id": 1,
  "amount": 100,
  "service_id": 1,
  "order_id": 1
}
```

#### Ответ

##### Успешный резерв

```json
{
  "balance": 900,
  "user_id": 1
}
```

Код ответа `201`. Поле `balance` содержит баланс пользователя после резерва. Поле `user_id` содержит переданный
идентификатор
пользователя.

##### Ошибка при обработке

```json
{
  "error": "insufficient balance to provide a transaction"
}
```

Код ответа `400`. Поле `error` содержит описание ошибки.

### Признание выручки

#### Запрос

```http
POST /transactions/withdraw
```

| Параметр     | Тип     | Описание                                     |
|:-------------|:--------|:---------------------------------------------|
| `user_id`    | `int64` | **Обязательный**. Идентификатор пользователя |
| `amount`     | `int64` | **Обязательный**. Сумма признаваемой выручки |
| `service_id` | `int64` | **Обязательный**. Идентификатор услуги       |
| `order_id`   | `int64` | **Обязательный**. Идентификатор заказа       |

```json
{
  "user_id": 1,
  "amount": 100,
  "service_id": 1,
  "order_id": 1
}
```

#### Ответ

##### Успешное признание выручки

```json
{
  "balance": 900,
  "user_id": 1
}
```

Код ответа `201`. Поле `balance` содержит баланс пользователя после признания выручки. Поле `user_id` содержит
переданный идентификатор
пользователя.

##### Ошибка при обработке

```json
{
  "error": "not found transaction to withdrawal"
}
```

Код ответа `400`. Поле `error` содержит описание ошибки.

### Получение баланса пользователя

#### Запрос

```http
GET /users
```

| Параметр     | Тип     | Описание                                     |
|:-------------|:--------|:---------------------------------------------|
| `id`         | `int64` | **Обязательный**. Идентификатор пользователя |

#### Ответ

##### Успешный ответ

```json
{
  "balance": 900,
  "id": 1,
  "reserved": 0
}
```

Код ответа `200`. Поле `balance` содержит баланс пользователя. Поле `id` содержит переданный идентификатор
пользователя. Поле `reserved` содержит сумму всех активных резервов пользователя.

### Формирование отчета для бухгалтерии

Метод формирует отчет и сохраняет его для будущих запросов. В случае, если отчет за данный период уже был создан, и с
момента формирования отчета в данном периоде не было создано новых транзакций, возвращается сохраненный отчет.

#### Запрос

```http
POST /v1/report
```

| Параметр | Тип   | Описание                                        |
|:---------|:------|:------------------------------------------------|
| `year`   | `int` | **Обязательный**. Год для формирования отчета   |
| `month`  | `int` | **Обязательный**. Месяц для формирования отчета |

```json
{
  "year": 2022,
  "month": 11
}
```

#### Ответ

##### Успешное формирование отчета

```json
{
  "url": "http://localhost:8080/data/0df1e942-66a9-11ed-b565-0242ac1c0003.csv"
}
```

Код ответа `201`. Поле `url` содержит ссылку на CSV файл с отчетом.

## Вопросы и ответы

**Нужно ли поддерживать не целые суммы в транзакциях?** Нет, деньги в системе хранятся в минимальной возможной валюте (
например, копейках) для работы только с целыми числами.

**Может ли один сервис несколько раз списать деньги в рамках одного заказа?** Нет, сделано для защиты в случае повторных
запросов.

**Являются ли идентификаторы услуг и заказов целыми числами?** Да.

**Как должен вести себя сервис при попытке списания по несуществующему пользователю?** Согласно условию в этот момент не
создается пользователь, но ошибка идентична ошибке отсутствия баланса для простоты обработки внешним сервисом.


